# CLAUDE.md

## Project Overview

PeFi (Personal Finance) - a personal wealth management and financial forecasting MPA with server-side rendering. Built with Go, Templ, HTMX, TailwindCSS/DaisyUI, and SQLite.

## Tech Stack

- **Backend:** Go 1.25, custom HTTP server with `goslu` utility library
- **Database:** SQLite (via `ncruces/go-sqlite3`), SQLC for type-safe query generation
- **Templates:** Templ (`.templ` files generate Go code)
- **Frontend:** HTMX (minimal JS), TailwindCSS + DaisyUI, ECharts for visualizations
- **Architecture:** MPA with SSR, "group by feature" code organization

## Common Commands

```bash
make run              # Dev server on :3002 with in-memory DB
make generate         # Generate SQLC, Templ, and TailwindCSS (run after changing .templ, .sql, or styles)
make generate-watch   # Same as generate but skips templ (use when watch-templ is running)
make watch-templ      # Templ hot-reload with proxy (primary dev workflow)
make watch-tw         # Watch TailwindCSS for changes
make docker-build     # Build Docker image with Podman
go test ./...         # Run all tests
go build ./...        # Verify compilation
```

**IMPORTANT:** The user runs `make watch-templ` during development. Never run `make generate` as it will crash the templ watcher. Use `make generate-watch` instead, which skips templ generation (the watcher handles it automatically).

## Browser Testing with Rodney

**Rodney** lets AI agents interact with the browser for testing. Run `rodney --help` to see usage and available commands (e.g. taking screenshots, navigating, clicking). Use it when:

- **Generating PRs** — capture screenshots of new or changed features for the PR description
- **Developing features** — get visual feedback by screenshotting pages or flows
- **Verifying UI** — confirm layouts and behavior after changes

## Development Documentation (Showboat)

**Showboat** is used for development documentation. When the user requests documentation of the development setup, workflow, or similar, use or reference Showboat (e.g. run `showboat --help` to see options) to generate or provide that documentation.

## Project Structure

```
cmd/main.go                        # Entry point, delegates to core.Run()
internal/
  core/                            # Main feature code (handlers, views, services)
    handler.go                     # HTTP route registration
    run.go                         # App startup & server config
    service_*.go                   # Feature services
    {feature}_view.templ           # Templ templates per feature
  finance/                         # Financial forecasting engine (Monte Carlo, growth models)
  pdb/                             # Generated SQLC database code (DO NOT EDIT)
  ui/                              # UI utilities (formatting, parsing)
  uncertain/                       # Probabilistic value handling
static/
  migrations/*.sql                 # SQLite migrations (numbered 0001-0011)
  public/                          # Static assets (CSS, JS, images)
sqlc/
  queries/*.sql                    # SQL query definitions for SQLC
  sqlc.yml                         # SQLC configuration
tailwind/                          # TailwindCSS source + DaisyUI config
```

## Feature Implementation Pattern

When adding a new feature, follow this order:

1. **Database:** Add migration in `static/migrations/*.sql`, add queries in `sqlc/queries/*.sql`
2. **Generate:** Run `make generate-watch` to create Go code from SQL and templates (templ is handled by the watcher)
3. **Business logic:** Create `internal/core/{feature}.go` with handlers, types, and CRUD functions
4. **Views:** Create `internal/core/{feature}_view.templ` with page, list, edit, and form components
5. **Routes:** Register routes in `internal/core/handler.go`
6. **Navigation:** Add nav item in `internal/core/view_main.templ`, icon in `view_icons.templ`

## Code Patterns

- HTTP handlers use `srvu.ErrHandlerFunc` wrapper for error handling
- Form decoding: `srvu.Decode(r, &input, false)`
- Redirects: `shttp.RedirectToNext(w, r, url)`
- Files in `internal/pdb/` are auto-generated by SQLC — never edit manually
- Files ending in `_templ.go` are auto-generated by Templ — never edit manually
- Always run `make generate-watch` after modifying `.sql` files (templ changes are picked up automatically by the watcher)

## Key Conventions

- Minimal JavaScript — prefer HTMX and server-side rendering
- No explicit linter configured; use standard Go formatting (`gofmt`)
- Tests exist in `internal/finance/` and `internal/core/` — run with `go test ./...`
- Avoid dependencies when possible
